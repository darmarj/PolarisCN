
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="One branded static site from a set of Markdown files to host the documentation for Open Source or Commercial project">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-7.3.6">
    
    
      
        <title>OpenKruise - POLARISCN</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.03d4cea5.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      


    
    
  <link rel="stylesheet" href="../../overrides/assets/stylesheets/main.bf3dc0a9.min.css">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#openkruise" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner md-announce">
          <div class="md-banner__inner md-announce__inner md-grid md-typeset">
            
  <a href="https://github.com/darmarj">
    For updates follow <strong>NEWs</strong> on
    <span class="twemoji twitter">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </span>
    <strong>Github</strong>
  </a>

          </div>
        </aside>
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="POLARISCN" class="md-header__button md-logo" aria-label="POLARISCN" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            POLARISCN
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenKruise
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/darmarj" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    darmarj
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Container/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6/" class="md-tabs__link">
        容器运行时
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Foundation/K8s%20Introduction/" class="md-tabs__link">
        基础
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ReplicaSet/" class="md-tabs__link md-tabs__link--active">
        控制器
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../ConfigManage/ConfigMap/" class="md-tabs__link">
        配置管理
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="POLARISCN" class="md-nav__button md-logo" aria-label="POLARISCN" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    POLARISCN
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/darmarj" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    darmarj
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          容器运行时
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="容器运行时" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          容器运行时
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Container/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6/" class="md-nav__link">
        容器运行时介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Container/containerd/" class="md-nav__link">
        Containerd的使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Container/nerdctl/" class="md-nav__link">
        命令行工具Nerdctl
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Container/namespace%26cgroups/" class="md-nav__link">
        CGroups与Namespaces
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/K8s%20Introduction/" class="md-nav__link">
        K8S简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/K8s%20Installation/" class="md-nav__link">
        集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/YAML/" class="md-nav__link">
        资源清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/Pod/" class="md-nav__link">
        Pod原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/Pod%20lifeCycle/" class="md-nav__link">
        Pod生命周期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Foundation/Pod%20inAdvance/" class="md-nav__link">
        Pod使用进阶
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          控制器
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="控制器" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          控制器
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ReplicaSet/" class="md-nav__link">
        ReplicaSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Deployment/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../StatefulSet/" class="md-nav__link">
        StatefulSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../DaemonSet/" class="md-nav__link">
        DaemonSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Job%26CronJob/" class="md-nav__link">
        Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../HPA/" class="md-nav__link">
        HPA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Admission/" class="md-nav__link">
        Admission
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Crd/" class="md-nav__link">
        Crd
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          OpenKruise
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        OpenKruise
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloneset" class="md-nav__link">
    CloneSet
  </a>
  
    <nav class="md-nav" aria-label="CloneSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    扩缩容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloneset_1" class="md-nav__link">
    CloneSet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-statefulset" class="md-nav__link">
    Advanced StatefulSet
  </a>
  
    <nav class="md-nav" aria-label="Advanced StatefulSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    最大不可用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    原地升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-daemonset" class="md-nav__link">
    Advanced DaemonSet
  </a>
  
    <nav class="md-nav" aria-label="Advanced DaemonSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#broadcastjob" class="md-nav__link">
    BroadcastJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advancedcronjob" class="md-nav__link">
    AdvancedCronJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sidecarset" class="md-nav__link">
    SidecarSet
  </a>
  
    <nav class="md-nav" aria-label="SidecarSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    统一特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    金丝雀发布
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    热升级
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    热升级流程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-restart" class="md-nav__link">
    Container Restart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imagepulljob" class="md-nav__link">
    ImagePullJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    容器启动顺序
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          配置管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="配置管理" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          配置管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/ConfigMap/" class="md-nav__link">
        ConfigMap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/Secret/" class="md-nav__link">
        Secret
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/RBAC/" class="md-nav__link">
        RBAC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/Security%20Context/" class="md-nav__link">
        Security Context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/OPA/" class="md-nav__link">
        OPA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ConfigManage/Kyverno/" class="md-nav__link">
        Kyverno
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloneset" class="md-nav__link">
    CloneSet
  </a>
  
    <nav class="md-nav" aria-label="CloneSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    扩缩容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloneset_1" class="md-nav__link">
    CloneSet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-statefulset" class="md-nav__link">
    Advanced StatefulSet
  </a>
  
    <nav class="md-nav" aria-label="Advanced StatefulSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    最大不可用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    原地升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-daemonset" class="md-nav__link">
    Advanced DaemonSet
  </a>
  
    <nav class="md-nav" aria-label="Advanced DaemonSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#broadcastjob" class="md-nav__link">
    BroadcastJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advancedcronjob" class="md-nav__link">
    AdvancedCronJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sidecarset" class="md-nav__link">
    SidecarSet
  </a>
  
    <nav class="md-nav" aria-label="SidecarSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    统一特性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    金丝雀发布
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    热升级
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    热升级流程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-restart" class="md-nav__link">
    Container Restart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imagepulljob" class="md-nav__link">
    ImagePullJob
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    容器启动顺序
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="openkruise">OpenKruise<a class="headerlink" href="#openkruise" title="Permanent link">&para;</a></h1>
<p><a href="https://openkruise.io/">OpenKruise</a> 是一个基于 Kubernetes 的 <strong>扩展套件</strong>，主要聚焦于云原生应用的自动化，比如部署、发布、运维以及可用性防护。<ins class="critic">OpenKruise 提供的绝大部分能力都是基于 CRD 扩展来定义的，它们不存在于任何外部依赖，可以运行在任意纯净的 Kubernetes 集群中</ins>。Kubernetes 自身提供的一些应用部署管理功能，对于大规模应用与集群的场景这些功能是远远不够的，<ins class="critic"><strong>OpenKruise 弥补了 Kubernetes 在应用部署、升级、防护、运维等领域的不足</strong></ins>。</p>
<p>OpenKruise 提供了以下的一些核心能力：</p>
<ul>
<li><strong>增强版本的 Workloads</strong>：OpenKruise 包含了一系列增强版本的工作负载，比如 CloneSet、Advanced StatefulSet、Advanced DaemonSet、BroadcastJob 等。它们不仅支持类似于 Kubernetes 原生 Workloads 的基础功能，还提供了如原地升级、可配置的扩缩容/发布策略、并发操作等。其中，原地升级是一种升级应用容器镜像甚至环境变量的全新方式，它只会用新的镜像重建 Pod 中的特定容器，整个 Pod 以及其中的其他容器都不会被影响。因此它带来了更快的发布速度，以及避免了对其他 Scheduler、CNI、CSI 等组件的负面影响。</li>
<li><strong>应用的旁路管理</strong>：OpenKruise 提供了多种通过旁路管理应用 sidecar 容器、多区域部署的方式，“旁路” 意味着你可以不需要修改应用的 Workloads 来实现它们。比如，SidecarSet 能帮助你在所有匹配的 Pod 创建的时候都注入特定的 sidecar 容器，甚至可以原地升级已经注入的 sidecar 容器镜像、并且对 Pod 中其他容器不造成影响。而 WorkloadSpread 可以约束无状态 Workload 扩容出来 Pod 的区域分布，赋予单一 Workload 的多区域和弹性部署的能力。</li>
<li><strong>高可用性防护</strong>：OpenKruise 可以保护你的 Kubernetes 资源不受级联删除机制的干扰，包括 CRD、Namespace、以及几乎全部的 Workloads 类型资源。相比于 Kubernetes 原生的 PDB 只提供针对 Pod Eviction 的防护，PodUnavailableBudget 能够防护 Pod Deletion、Eviction、Update 等许多种 voluntary disruption 场景。</li>
<li><strong>高级的应用运维能力</strong>：OpenKruise 也提供了很多高级的运维能力来帮助你更好地管理应用，比如可以通过 ImagePullJob 来在任意范围的节点上预先拉取某些镜像，或者指定某个 Pod 中的一个或多个容器被原地重启。</li>
</ul>
<h2 id="_1">架构<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>下图是 OpenKruise 的整体架构：</p>
<p><a href="../../assets/images/OpenKruiseArch.png" title="OpenKruiseArch.png"><img alt="OpenKruiseArch" src="../../assets/images/OpenKruiseArch.png" title="OpenKruiseArch" /></a></p>
<p>首先我们要清楚所有 OpenKruise 的功能都是通过 Kubernetes CRD 来提供的：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>crd<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kruise.io
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>advancedcronjobs.apps.kruise.io<span class="w">            </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>broadcastjobs.apps.kruise.io<span class="w">               </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>clonesets.apps.kruise.io<span class="w">                   </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>containerrecreaterequests.apps.kruise.io<span class="w">   </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>daemonsets.apps.kruise.io<span class="w">                  </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>imagepulljobs.apps.kruise.io<span class="w">               </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>nodeimages.apps.kruise.io<span class="w">                  </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>podunavailablebudgets.policy.kruise.io<span class="w">     </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>resourcedistributions.apps.kruise.io<span class="w">       </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>sidecarsets.apps.kruise.io<span class="w">                 </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>statefulsets.apps.kruise.io<span class="w">                </span><span class="m">2021</span>-09-16T06:02:36Z
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>uniteddeployments.apps.kruise.io<span class="w">           </span><span class="m">2021</span>-09-16T06:02:37Z
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>workloadspreads.apps.kruise.io<span class="w">             </span><span class="m">2021</span>-09-16T06:02:37Z
</code></pre></div>
<p>其中 <code class="highlight"><span class="nt">Kruise-manager</span></code> 是一个运行控制器和 webhook 的中心组件，它通过 <code>Deployment</code> 部署在 kruise-system 命名空间中。 从逻辑上来看，如 <code>cloneset-controller</code>、<code>sidecarset-controller</code> 这些的控制器都是独立运行的，不过为了减少复杂度，它们都被打包在一个独立的二进制文件、并运行在 kruise-controller-manager-xxx 这个 Pod 中。除了控制器之外，kruise-controller-manager-xxx 中还包含了针对 <code>Kruise CRD</code> 以及 Pod 资源的 <code>admission webhook</code>。<code class="highlight"><span class="nt">Kruise-manager</span></code> 会创建一些 webhook configurations 来配置哪些资源需要感知处理、以及提供一个 Service 来给 kube-apiserver 调用。</p>
<p>从 v0.8.0 版本开始提供了一个新的 <code class="highlight"><span class="nt">Kruise-daemon</span></code> 组件，它通过 <code>DaemonSet</code> 部署到每个节点上，提供镜像预热、容器重启等功能。</p>
<p>可以通过查阅这些<a href="https://github.com/openkruise/kruise/releases">发布的新功能</a>。</p>
<h2 id="_2">安装<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>这里我们同样还是使用 Helm 方式来进行安装，<ins class="critic"><strong>需要注意从 v1.0.0 开始，OpenKruise 要求在 Kubernetes &gt;= 1.16 以上版本的集群中安装和使用</strong></ins>。</p>
<p>首先添加 charts 仓库：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>➜<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>openkruise<span class="w"> </span>https://openkruise.github.io/charts
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>➜<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</code></pre></div>
<p>然后执行下面的命令安装最新版本的应用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>➜<span class="w"> </span>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>kruise<span class="w"> </span>openkruise/kruise<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.1.0
</code></pre></div>
<p>该 <code>charts</code> 在模板中默认定义了命名空间为 <code>kruise-system</code>，所以在安装的时候可以不用指定，如果你的环境访问 DockerHub 官方镜像较慢，则可以使用下面的命令将镜像替换成阿里云的镜像：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>➜<span class="w"> </span>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>kruise<span class="w"> </span>openkruise/kruise<span class="w"> </span>--set<span class="w"> </span>manager.image.repository<span class="o">=</span>openkruise-registry.cn-hangzhou.cr.aliyuncs.com/openkruise/kruise-manager<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.0.1
</code></pre></div>
<p>应用部署完成后会在 kruise-system 命名空间下面运行2个 kruise-manager 的 Pod，同样它们之间采用 <code class="highlight"><span class="nt">leader-election</span></code> 的方式选主，同一时间只有一个提供服务，达到高可用的目的，此外还会以 DaemonSet 的形式启动 kruise-daemon 组件：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kruise-system
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>NAME<span class="w">                                        </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>kruise-controller-manager-f5c9b55c5-7hgt9<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m3s
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>kruise-controller-manager-f5c9b55c5-v9ptf<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m3s
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>kruise-daemon-bqf5v<span class="w">                         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m3s
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>kruise-daemon-hvgwv<span class="w">                         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m3s
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>kruise-daemon-tnqsx<span class="w">                         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m3s
</code></pre></div>
<p>如果不想使用默认的参数进行安装，也可以自定义配置，可配置的 values 值可以参考 <a href="https://github.com/openkruise/charts/tree/master/versions">charts 文档</a> 进行定制。</p>
<h2 id="cloneset">CloneSet<a class="headerlink" href="#cloneset" title="Permanent link">&para;</a></h2>
<p>CloneSet 控制器是 OpenKruise 提供的对原生 Deployment 的增强控制器，在使用方式上和 Deployment 几乎一致，如下所示是我们声明的一个 CloneSet 资源对象：
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># cloneset-demo.yaml</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CloneSet</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs-demo</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:alpine</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div></p>
<p>直接创建上面的这个 CloneSet 对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl apply -f cloneset-demo.yaml</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl get cloneset cs-demo</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="l l-Scalar l-Scalar-Plain">NAME      DESIRED   UPDATED   UPDATED_READY   READY   TOTAL   AGE</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="l l-Scalar l-Scalar-Plain">cs-demo   3         3         3               3       3       112s</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl describe cloneset cs-demo</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span><span class="w">         </span><span class="l l-Scalar l-Scalar-Plain">cs-demo</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l l-Scalar l-Scalar-Plain">&lt;none&gt;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="nt">Annotations:  kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">                </span><span class="p p-Indicator">{</span><span class="s">&quot;apiVersion&quot;</span><span class="p p-Indicator">:</span><span class="s">&quot;apps.kruise.io/v1alpha1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;kind&quot;</span><span class="p p-Indicator">:</span><span class="s">&quot;CloneSet&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;metadata&quot;</span><span class="p p-Indicator">:{</span><span class="s">&quot;annotations&quot;</span><span class="p p-Indicator">:{},</span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="s">&quot;cs-demo&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;namespace&quot;</span><span class="p p-Indicator">:</span><span class="s">&quot;default&quot;</span><span class="p p-Indicator">},</span><span class="s">&quot;spec&quot;</span><span class="p p-Indicator">:{</span><span class="s">&quot;re...</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="s">API</span><span class="nv"> </span><span class="s">Version:</span><span class="nv">  </span><span class="s">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="s">Kind:</span><span class="nv">         </span><span class="s">CloneSet</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="s">......</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="s">Events:</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">  </span><span class="s">Type</span><span class="nv">    </span><span class="s">Reason</span><span class="nv">            </span><span class="s">Age</span><span class="nv">   </span><span class="s">From</span><span class="nv">                 </span><span class="s">Message</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">  </span><span class="s">----</span><span class="nv">    </span><span class="s">------</span><span class="nv">            </span><span class="s">----</span><span class="nv">  </span><span class="s">----</span><span class="nv">                 </span><span class="s">-------</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="hll"><span class="w">  </span><span class="s">Normal</span><span class="nv">  </span><span class="s">SuccessfulCreate</span><span class="nv">  </span><span class="s">53s</span><span class="nv">   </span><span class="s">cloneset-controller</span><span class="nv">  </span><span class="s">succeed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">create</span><span class="nv"> </span><span class="s">pod</span><span class="nv"> </span><span class="s">cs-demo-b6r6t</span>
</span><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="hll"><span class="w">  </span><span class="s">Normal</span><span class="nv">  </span><span class="s">SuccessfulCreate</span><span class="nv">  </span><span class="s">53s</span><span class="nv">   </span><span class="s">cloneset-controller</span><span class="nv">  </span><span class="s">succeed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">create</span><span class="nv"> </span><span class="s">pod</span><span class="nv"> </span><span class="s">cs-demo-fsbx5</span>
</span><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="hll"><span class="w">  </span><span class="s">Normal</span><span class="nv">  </span><span class="s">SuccessfulCreate</span><span class="nv">  </span><span class="s">53s</span><span class="nv">   </span><span class="s">cloneset-controller</span><span class="nv">  </span><span class="s">succeed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">create</span><span class="nv"> </span><span class="s">pod</span><span class="nv"> </span><span class="s">cs-demo-fv5gb</span>
</span></code></pre></div>
<p>该对象创建完成后我们可以通过 kubectl describe 命令查看对应的 Events 信息，可以发现 <code>cloneset-controller</code> 是直接创建的 Pod，<ins class="critic">这个和原生的 Deployment 就有一些区别了</ins>，Deployment 是通过 ReplicaSet 去创建的 Pod，所以从这里也可以看出来 <ins class="critic"><strong>CloneSet 是直接管理 Pod 的</strong></ins>，3个副本的 Pod 此时也创建成功了：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>cs
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>NAME<span class="w">            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>cs-demo-b6r6t<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m19s
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>cs-demo-fsbx5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m19s
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>cs-demo-fv5gb<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>5m19s
</code></pre></div>
<p>CloneSet 虽然在使用上和 Deployment 比较类似，但还是有非常多比 Deployment 更高级的功能，下面我们来详细介绍下。</p>
<h3 id="_3">扩缩容<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>CloneSet 在扩容的时候可以通过 <code class="highlight"><span class="nt">ScaleStrategy</span><span class="p">.</span><span class="nc">MaxUnavailable</span></code> 来限制扩容的步长，这样可以对服务应用的影响最小，可以设置一个绝对值或百分比，如果不设置该值，则表示不限制。</p>
<p>比如我们在上面的资源清单中的Pod&rarr;Spec里面添加如下所示数据：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">scaleStrategy</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">......</span>
</code></pre></div>
<p>上面我们配置 <code class="highlight"><span class="nt">scaleStrategy</span><span class="p">.</span><span class="nc">maxUnavailable</span></code> 为1，结合 <code class="highlight"><span class="nt">minReadySeconds</span></code> 参数，表示在扩容时，只有当上一个扩容出的 Pod 已经 Ready 超过一分钟后，CloneSet 才会执行创建下一个 Pod，比如这里我们扩容成5个副本，更新上面对象后查看 CloneSet 的事件：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>cloneset<span class="w"> </span>cs-demo
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>......
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>Events:
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span>Type<span class="w">     </span>Reason<span class="w">            </span>Age<span class="w">                   </span>From<span class="w">                 </span>Message
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span>----<span class="w">     </span>------<span class="w">            </span>----<span class="w">                  </span>----<span class="w">                 </span>-------
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>35m<span class="w">                   </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-b6r6t
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>35m<span class="w">                   </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-fsbx5
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>35m<span class="w">                   </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-fv5gb
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">  </span>Warning<span class="w">  </span>ScaleUpLimited<span class="w">    </span>2m39s<span class="w">                 </span>cloneset-controller<span class="w">  </span>scaleUp<span class="w"> </span>is<span class="w"> </span>limited<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>scaleStrategy.maxUnavailable,<span class="w"> </span>limit:<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>2m39s<span class="w">                 </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-xlsdg
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>98s<span class="w">                   </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-8w7h4
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">  </span>Warning<span class="w">  </span>ScaleUpLimited<span class="w">    </span>68s<span class="w"> </span><span class="o">(</span>x12<span class="w"> </span>over<span class="w"> </span>2m39s<span class="o">)</span><span class="w">  </span>cloneset-controller<span class="w">  </span>scaleUp<span class="w"> </span>is<span class="w"> </span>limited<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>scaleStrategy.maxUnavailable,<span class="w"> </span>limit:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">  </span>37s<span class="w">                   </span>cloneset-controller<span class="w">  </span>succeed<span class="w"> </span>to<span class="w"> </span>create<span class="w"> </span>pod<span class="w"> </span>cs-demo-79rcx
</code></pre></div>
<p>可以看到第一时间扩容了一个 Pod，由于我们配置了 <code class="highlight"><span class="nt">minReadySeconds</span><span class="o">:</span><span class="w"> </span><span class="nt">60</span></code>，也就是新扩容的 Pod 创建成功超过1分钟后才会扩容另外一个 Pod，上面的 Events 信息也能表现出来，查看 Pod 的 <code>AGE</code> 也能看出来扩容的2个 Pod 之间间隔了1分钟左右：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>cs
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>NAME<span class="w">            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>cs-demo-79rcx<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>2m3s
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>cs-demo-8w7h4<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>3m4s
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>cs-demo-b6r6t<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36m
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>cs-demo-fv5gb<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36m
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>cs-demo-p4kmw<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36s
</code></pre></div>
<p>当 CloneSet 被缩容时，我们还可以指定一些 Pod 来删除，<ins class="critic">这对于 StatefulSet 或者 Deployment 来说是无法实现的， StatefulSet 是根据序号来删除 Pod，而 Deployment/ReplicaSet 目前只能根据控制器里定义的排序来删除</ins>。而 CloneSet 允许用户在缩小 replicas 数量的同时，指定想要删除的 Pod 名字，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="nt">scaleStrategy</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="hll"><span class="w">    </span><span class="nt">podsToDelete</span><span class="p">:</span>
</span><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs-demo-79rcx</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">......</span>
</code></pre></div>
<p>更新上面的资源对象后，会将应用缩到4个 Pod，如果在 <code>podsToDelete</code> 列表中指定了 Pod 名字，则控制器会优先删除这些 Pod，对于已经被删除的 Pod，控制器会自动从 podsToDelete 列表中清理掉。比如我们更新上面的资源对象后 cs-demo-79rcx 这个 Pod 会被移除，其余会保留下来：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>cs
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>NAME<span class="w">            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">      </span>AGE
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>cs-demo-8w7h4<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>51m<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>3d6h
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>cs-demo-b6r6t<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>51m<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>3d6h
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>cs-demo-fv5gb<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>51m<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>3d6h
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>cs-demo-p4kmw<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>51m<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>3d6h
</code></pre></div>
<p>如果你只把 Pod 名字加到 podsToDelete，但没有修改 replicas 数量，那么控制器会先把指定的 Pod 删掉，然后再扩一个新的 Pod，另一种直接删除 Pod 的方式是在要删除的 Pod 上打 <code class="highlight"><span class="nt">apps.kruise.io/specified-delete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span></code> 标签。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># cs-demo-b6r6t will be deleted by label</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>label<span class="w"> </span>pod<span class="w"> </span>cs-demo-b6r6t<span class="w"> </span>apps.kruise.io/specified-delete<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>相比于手动直接删除 Pod，使用 <code>podsToDelete</code> 或 <code>apps.kruise.io/specified-delete: true</code> 方式会有 CloneSet 的 <code>maxUnavailable/maxSurge</code>  来保护删除， 并且会触发 PreparingDelete <a href="https://openkruise.io/docs/user-manuals/cloneset#lifecycle-hook">生命周期的钩子</a>。</p>
<p><img alt="OpenKruiseCloneset-Lifecycle" src="../../assets/images/OpenKruiseCloneset-Lifecycle.png" title="OpenKruiseCloneset-Lifecycle" /></p>
<h3 id="cloneset_1"><a href="https://openkruise.io/docs/user-manuals/cloneset">CloneSet</a><a class="headerlink" href="#cloneset_1" title="Permanent link">&para;</a></h3>
<p>CloneSet 一共提供了 3 种升级方式：</p>
<ul>
<li><strong>ReCreate</strong>: 删除旧 Pod 和它的 PVC，然后用新版本重新创建出来，这是默认的方式</li>
<li><strong>InPlaceIfPossible</strong>: 会优先尝试原地升级 Pod，如果不行再采用重建升级</li>
<li><strong>InPlaceOnly</strong>: 只允许采用原地升级，因此，用户只能修改上一条中的限制字段，如果尝试修改其他字段会被拒绝</li>
</ul>
<p>这里有一个重要概念：<span class="jade">原地升级</span>，这也是 OpenKruise 提供的核心功能之一，当我们要升级一个 Pod 中镜像的时候，下图展示了重建升级和原地升级的区别：</p>
<p><a href="../../assets/images/OpenKruiseUpdate.png"><img alt="OpenKruiseUpdate" src="../../assets/images/OpenKruiseUpdate.png" title="OpenKruiseUpdate" /></a></p>
<div class="admonition info">
<p class="admonition-title">重建升级时我们需要删除旧 Pod、创建新 Pod</p>
<ol>
<li>Pod 名字和 uid 发生变化，因为它们是完全不同的两个 Pod 对象（比如 Deployment 升级）</li>
<li>Pod 名字可能不变、但 uid 变化，因为它们是不同的 Pod 对象，只是复用了同一个名字（比如 StatefulSet 升级）</li>
<li>Pod 所在 Node 名字可能发生变化，因为新 Pod 很可能不会调度到之前所在的 Node 节点</li>
<li>Pod IP 发生变化，因为新 Pod 很大可能性是不会被分配到之前的 IP 地址</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title">但是对于原地升级，我们仍然复用同一个 Pod 对象，只是修改它里面的字段</p>
<ol>
<li>可以避免如调度、分配 IP、挂载盘等额外的操作和代价</li>
<li>更快的镜像拉取，因为会复用已有旧镜像的大部分 layer 层，只需要拉取新镜像变化的一些 layer</li>
<li>当一个容器在原地升级时，Pod 中的其他容器不会受到影响，仍然维持运行</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title">显然，如果能用原地升级方式来升级我们的工作负载，对在线应用的影响是最小的。上面我们提到 CloneSet 升级类型支持 <code class="highlight"><span class="nt">InPlaceIfPossible</span></code>，这意味着 Kruise 会尽量对 Pod 采取原地升级，如果不能则退化到重建升级，以下的改动会被允许执行原地升级</p>
<ol>
<li>更新 workload 中的 spec.template.metadata.*，比如 labels/annotations，Kruise 只会将 metadata 中的改动更新到存量 Pod 上。</li>
<li>更新 workload 中的 spec.template.spec.containers[x].image，Kruise 会原地升级 Pod 中这些容器的镜像，而不会重建整个 Pod。</li>
<li>从 Kruise v1.0 版本开始，更新 spec.template.metadata.labels/annotations 并且 container 中有配置 env from 这些改动的 labels/anntations，Kruise 会原地升级这些容器来生效新的 env 值。</li>
</ol>
</div>
<p>否则，其他字段的改动，比如 <code>spec.template.spec.containers[x].env</code> 或 <code>spec.template.spec.containers[x].resources</code>，都是会回退为重建升级。</p>
<p>比如我们将上面的应用升级方式设置为 <code>InPlaceIfPossible</code>，只需要在资源清单中添加 <code class="highlight"><span class="nt">spec.updateStrategy.type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InPlaceIfPossible</span></code> 即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CloneSet</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs-demo</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="hll"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InPlaceIfPossible</span>
</span><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">......</span>
</code></pre></div>
<p>更新后可以发现 Pod 的状态并没有发生什么大的变化，名称、IP 都一样，唯一变化的是镜像 tag：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl get pods -l app=cs</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="l l-Scalar l-Scalar-Plain">NAME            READY   STATUS    RESTARTS      AGE</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="l l-Scalar l-Scalar-Plain">cs-demo-8w7h4   1/1     Running   4 (55m ago)   3d6h</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="l l-Scalar l-Scalar-Plain">cs-demo-b6r6t   1/1     Running   4 (55m ago)   3d6h</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="l l-Scalar l-Scalar-Plain">cs-demo-fv5gb   1/1     Running   5 (20s ago)   3d6h</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="l l-Scalar l-Scalar-Plain">cs-demo-p4kmw   1/1     Running   5 (83s ago)   3d6h</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl describe cloneset cs-demo</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span><span class="w">         </span><span class="l l-Scalar l-Scalar-Plain">cs-demo</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l l-Scalar l-Scalar-Plain">&lt;none&gt;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="nt">Annotations</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">&lt;none&gt;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="nt">API Version</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="nt">Kind</span><span class="p">:</span><span class="w">         </span><span class="l l-Scalar l-Scalar-Plain">CloneSet</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="nt">Events</span><span class="p">:</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Type    Reason                      Age    From                 Message</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">----    ------                      ----   ----                 -------</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal  SuccessfulDelete            4m44s  cloneset-controller  succeed to delete pod cs-demo-79rcx</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal  SuccessfulUpdatePodInPlace  97s    cloneset-controller  successfully update pod cs-demo-p4kmw in-place(revision cs-demo-7cb9c88699)</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal  SuccessfulUpdatePodInPlace  34s    cloneset-controller  successfully update pod cs-demo-fv5gb in-place(revision cs-demo-7cb9c88699)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl describe pod cs-demo-p4kmw</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="nt">Events</span><span class="p">:</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Type     Reason                  Age                  From     Message</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">----     ------                  ----                 ----     -------</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal   Pulled                  56m                  kubelet  Container image &quot;nginx:alpine&quot; already present on machine</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal   Created                 2m28s (x2 over 56m)  kubelet  Created container nginx</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal   Killing                 2m28s                kubelet  Container nginx definition changed, will be restarted</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal   Pulled                  2m28s                kubelet  Container image &quot;nginx:1.7.9&quot; already present on machine</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Normal   Started                 2m27s (x2 over 56m)  kubelet  Started container nginx</span>
</code></pre></div>
<p>这就是原地升级的效果，原地升级整体工作流程如下图所示：</p>
<p><a href="../../assets/images/OpenKruiseUpdateFlow.png"><img alt="OpenKruiseUpdateFlow" src="../../assets/images/OpenKruiseUpdateFlow.png" title="OpenKruiseUpdateFlow.png" /></a></p>
<p>如果你在安装或升级 Kruise 的时候启用了 <code>PreDownloadImageForInPlaceUpdate</code> 这个 feature-gate，CloneSet 控制器会自动在所有旧版本 pod 所在节点上预热你正在灰度发布的新版本镜像，这对于应用发布加速很有帮助。</p>
<p>默认情况下 CloneSet 每个新镜像预热时的并发度都是 1，也就是一个个节点拉镜像，如果需要调整，你可以在 CloneSet annotation 上设置并发度：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CloneSet</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="nt">apps.kruise.io/image-predownload-parallelism</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>为了避免大部分不必要的镜像拉取，目前只针对 replicas &gt; 3 的 CloneSet 做自动预热。</p>
</div>
<p>此外 CloneSet 还支持分批进行灰度，在 <code class="highlight"><span class="nt">updateStrategy</span></code> 属性中可以配置 <code>partition</code> 参数，该参数可以用来保留旧版本 Pod 的数量或百分比，默认为0：</p>
<ul>
<li>如果是数字，控制器会将 (replicas - partition) 数量的 Pod 更新到最新版本</li>
<li>如果是百分比，控制器会将 (replicas * (100% - partition)) 数量的 Pod 更新到最新版本</li>
</ul>
<p>比如，我们将上面示例中的的 image 更新为 nginx:latest 并且设置 partition=2，更新后，过一会查看可以发现只升级了2个 Pod：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>cs<span class="w"> </span>-L<span class="w"> </span>controller-revision-hash
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>NAME<span class="w">            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">      </span>AGE<span class="w">    </span>CONTROLLER-REVISION-HASH
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>cs-demo-dx4lb<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">             </span>69s<span class="w">    </span>cs-demo-6599fc6cdd
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>cs-demo-fv5gb<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">             </span>3d7h<span class="w">   </span>cs-demo-7cb9c88699
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>cs-demo-nngtm<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">             </span>8s<span class="w">     </span>cs-demo-6599fc6cdd
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>cs-demo-p4kmw<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">             </span>3d6h<span class="w">   </span>cs-demo-7cb9c88699
</code></pre></div>
<p>此外 CloneSet 还支持一些更高级的用法，比如可以定义优先级策略来控制 Pod 发布的优先级规则，还可以定义策略来将一类 Pod 打散到整个发布过程中，也可以暂停 Pod 发布等操作。</p>
<h2 id="advanced-statefulset"><a href="https://openkruise.io/docs/user-manuals/advancedstatefulset">Advanced StatefulSet</a><a class="headerlink" href="#advanced-statefulset" title="Permanent link">&para;</a></h2>
<p>该控制器在原生的 StatefulSet 基础上增强了发布能力，比如 <code>maxUnavailable</code> 并行发布、原地升级等，该对象的名称也是 StatefulSet，但是 apiVersion 是 <code>apps.kruise.io/v1beta1</code>，这个 CRD 的所有默认字段、默认行为与原生 StatefulSet 完全一致，除此之外还提供了一些 optional 字段来扩展增强的策略。因此，用户从原生 StatefulSet 迁移到 Advanced StatefulSet，只需要把 apiVersion 修改后提交即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nt">+  apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">     </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sample</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w w-Error">   </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">     </span><span class="c1">#...</span>
</code></pre></div>
<h3 id="_4">最大不可用<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>Advanced StatefulSet 在滚动更新策略中新增了 maxUnavailable 来支持并行 Pod 发布，它会保证发布过程中最多有多少个 Pod 处于不可用状态。注意，maxUnavailable 只能配合 <code class="highlight"><span class="nt">podManagementPolicy</span></code> 为 <code>Parallel</code> 来使用。</p>
<p>这个策略的效果和 Deployment 中的类似，但是可能会导致发布过程中的 order 顺序不能严格保证，如果不配置 maxUnavailable，它的默认值为 1，也就是和原生 StatefulSet 一样只能串行发布 Pod，即使把 podManagementPolicy 配置为 Parallel 也是这样。</p>
<p>比如现在我们创建一个如下所示的 Advanced StatefulSet：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nginx-headless&quot;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">  </span><span class="nt">podManagementPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parallel</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">      </span><span class="c1"># partition: 4</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w">  </span><span class="c1"># @</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p>直接创建该对象，由于对象名称也是 StatefulSet，所以不能直接用 <code>get sts</code> 来获取了，要通过 <code>get asts</code> 获取：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>asts
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>NAME<span class="w">   </span>DESIRED<span class="w">   </span>CURRENT<span class="w">   </span>UPDATED<span class="w">   </span>READY<span class="w">   </span>AGE
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>web<span class="w">    </span><span class="m">5</span><span class="w">         </span><span class="m">5</span><span class="w">         </span><span class="m">5</span><span class="w">         </span><span class="m">5</span><span class="w">       </span>8m28s
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>NAME<span class="w">    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>web-0<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m52s
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>web-1<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m52s
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>web-2<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m52s
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>web-3<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m52s
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>web-4<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7m52s
</code></pre></div>
<p>该应用下有五个 Pod，假设应用能容忍 3 个副本不可用，当我们把 StatefulSet 里的 Pod 升级版本的时候，可以通过以下步骤来做：</p>
<ul>
<li>设置 maxUnavailable=3</li>
<li>(可选) 如果需要灰度升级，设置 partition=4，Partition 默认的意思是 order 大于等于这个数值的 Pod 才会更新，在这里就只会更新 P4，即使我们设置了 maxUnavailable=3。</li>
<li>在 P4 升级完成后，把 partition 调整为 0，此时，控制器会同时升级 P1、P2、P3 三个 Pod。注意，如果是原生 StatefulSet，只能串行升级 P3、P2、P1。</li>
<li>一旦这三个 Pod 中有一个升级完成了，控制器会立即开始升级 P0。</li>
</ul>
<p>比如这里我们把上面应用的镜像版本进行修改，更新后查看 Pod 状态，可以看到有3个 Pod 并行升级的：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>NAME<span class="w">    </span>READY<span class="w">   </span>STATUS<span class="w">              </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>web-0<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">             </span><span class="m">0</span><span class="w">          </span>2m41s
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>web-1<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">             </span><span class="m">0</span><span class="w">          </span>2m41s
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>web-2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>10s
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>web-3<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>10s
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>web-4<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>10s
</code></pre></div>
<h3 id="_5">原地升级<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>Advanced StatefulSet 增加了 <code class="highlight"><span class="nt">podUpdatePolicy</span></code> 来允许用户指定重建升级还是原地升级。此外还在原地升级中提供了 <code class="highlight"><span class="l l-Scalar l-Scalar-Plain">graceful period</span></code> 选项，作为优雅原地升级的策略。用户如果配置了 gracePeriodSeconds 这个字段，控制器在原地升级的过程中会先把 Pod status 改为 not-ready，然后等一段时间（<code>gracePeriodSeconds</code>），最后再去修改 Pod spec 中的镜像版本。这样，就为 endpoints-controller这些控制器留出了充足的时间来将 Pod 从 endpoints 端点列表中去除。</p>
<p>如果使用 InPlaceIfPossible 或 InPlaceOnly 策略，必须要增加一个 InPlaceUpdateReady readinessGate，用来在原地升级的时候控制器将 Pod 设置为 NotReady，比如设置上面的应用为原地升级的方式：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nginx-headless&quot;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">  </span><span class="nt">podManagementPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parallel</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">      </span><span class="nt">podUpdatePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InPlaceIfPossible</span><span class="w">  </span><span class="c1"># 尽可能执行原地升级</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"> </span><span class="c1"># 允许并行更新，最大不可以实例数为3</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">      </span><span class="nt">readinessGates</span><span class="p">:</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">conditionType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InPlaceUpdateReady</span><span class="w"> </span><span class="c1"># 一个新的条件，可确保 Pod 在发生原地更新时保持在 NotReady 状态</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p>这里我们设置 <code class="highlight"><span class="nt">updateStrategy</span><span class="p">.</span><span class="nc">rollingUpdate</span><span class="p">.</span><span class="nc">podUpdatePolicy</span></code> 为 <code>InPlaceIfPossible</code> 模式，表示尽可能使用原地升级的方式进行更新，此外在 Pod 模板中我们还添加了一个 <code>readinessGates</code> 属性，可以用来确保 Pod 在发生原地更新时保持在 NotReady 状态。比如我们现在使用上面资源清单更新应用，然后重新修改镜像的版本更新，则会进行原地升级：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>asts<span class="w"> </span>web
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>Events:
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span>Type<span class="w">    </span>Reason<span class="w">                      </span>Age<span class="w">                  </span>From<span class="w">                    </span>Message
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">  </span>----<span class="w">    </span>------<span class="w">                      </span>----<span class="w">                 </span>----<span class="w">                    </span>-------
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulUpdatePodInPlace<span class="w">  </span>3m30s<span class="w">                </span>statefulset-controller<span class="w">  </span>successfully<span class="w"> </span>update<span class="w"> </span>pod<span class="w"> </span>web-4<span class="w"> </span><span class="k">in</span>-place<span class="o">(</span>revision<span class="w"> </span>web-84644dfc7d<span class="o">)</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulUpdatePodInPlace<span class="w">  </span>3m30s<span class="w">                </span>statefulset-controller<span class="w">  </span>successfully<span class="w"> </span>update<span class="w"> </span>pod<span class="w"> </span>web-3<span class="w"> </span><span class="k">in</span>-place<span class="o">(</span>revision<span class="w"> </span>web-84644dfc7d<span class="o">)</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulUpdatePodInPlace<span class="w">  </span>3m30s<span class="w">                </span>statefulset-controller<span class="w">  </span>successfully<span class="w"> </span>update<span class="w"> </span>pod<span class="w"> </span>web-2<span class="w"> </span><span class="k">in</span>-place<span class="o">(</span>revision<span class="w"> </span>web-84644dfc7d<span class="o">)</span>
</code></pre></div>
<p>同样的 Advanced StatefulSet 也支持原地升级自动预热。</p>
<p>也可以通过设置 paused 为 true 来暂停发布，不过控制器还是会做 replicas 数量管理：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">      </span><span class="nt">paused</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p>另外 Advanced StatefulSet 还支持序号保留功能，通过在 <code>reserveOrdinals</code> 字段中写入需要保留的序号，Advanced StatefulSet 会自动跳过创建这些序号的 Pod，如果 Pod 已经存在，则会被删除。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>spec.replicas</code> 是期望运行的 Pod 数量，<code>spec.reserveOrdinals</code> 是要跳过的序号。</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span><span class="nt">reserveOrdinals</span><span class="p">:</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</code></pre></div>
<p>比如上面的描述 <code>replicas=4, reserveOrdinals=[1]</code> 的 Advanced StatefulSet，表示实际运行的 Pod 序号为 [0,2,3,4]。</p>
<div class="highlight"><pre><span></span><code>如果要把 Pod-3 做迁移并保留序号，则把 3 追加到 reserveOrdinals 列表中，控制器会把 Pod-3 删除并创建 Pod-5（此时运行中 Pod 为 [0,2,4,5]）。
如果只想删除 Pod-3，则把 3 追加到 reserveOrdinals 列表并同时把 replicas 减一修改为 3。控制器会把 Pod-3 删除（此时运行中 Pod 为 [0,2,4]）。
</code></pre></div>
<p>为了避免在一个新 Advanced StatefulSet 创建后有大量失败的 pod 被创建出来，从 Kruise v0.10.0 版本开始引入了在 scale strategy 中的 maxUnavailable 策略。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1beta1</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">  </span><span class="nt">scaleStrategy</span><span class="p">:</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10%</span><span class="w"> </span><span class="c1"># percentage or absolute number</span>
</code></pre></div>
<p>当这个字段被设置之后，Advanced StatefulSet 会保证创建 pod 之后不可用 pod 数量不超过这个限制值。比如说，上面这个 StatefulSet 一开始只会一次性创建 100*10%=10 个 pod，在此之后，每当一个 pod 变为 running、ready 状态后，才会再创建一个新 pod 出来。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这个功能只允许在 <code>podManagementPolicy</code> 是 Parallel 的 StatefulSet 中使用。</p>
</div>
<h2 id="advanced-daemonset"><a href="https://openkruise.io/docs/user-manuals/advanceddaemonset">Advanced DaemonSet</a><a class="headerlink" href="#advanced-daemonset" title="Permanent link">&para;</a></h2>
<p>这个控制器基于原生 DaemonSet 上增强了发布能力，比如灰度分批、按 Node label 选择、暂停、热升级等。同样的该对象的 Kind 名字也是 DaemonSet，只是 apiVersion 是 <code>apps.kruise.io/v1alpha1</code>，这个 CRD 的所有默认字段、默认行为与原生 DaemonSet 完全一致，除此之外还提供了一些 optional 字段来扩展增强的策略。</p>
<p>因此，用户从原生 DaemonSet 迁移到 Advanced DaemonSet，只需要把 apiVersion 修改后提交即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nt">+  apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">     </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sample-ds</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w w-Error">   </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">     </span><span class="c1">#...</span>
</code></pre></div>
<h3 id="_6">升级<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>Advanced DaemonSet 在 <code class="highlight"><span class="nt">spec</span><span class="p">.</span><span class="nc">updateStrategy</span><span class="p">.</span><span class="nc">rollingUpdate</span></code> 中有一个 <code>rollingUpdateType</code> 字段，标识了如何进行滚动升级：</p>
<ul>
<li><strong>Standard</strong>: 对于每个节点，控制器会先删除旧的 daemon Pod，再创建一个新 Pod，和原生 DaemonSet 行为一致。</li>
<li><strong>Surging</strong>: 对于每个 node，控制器会先创建一个新 Pod，等它 ready 之后再删除老 Pod。</li>
</ul>
<p>创建如下所示的资源对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">      </span><span class="nt">rollingUpdateType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p>创建后需要通过 <code>get daemon</code> 来获取该对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>daemon
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>NAME<span class="w">    </span>DESIREDNUMBER<span class="w">   </span>CURRENTNUMBER<span class="w">   </span>UPDATEDNUMBERSCHEDULED<span class="w">   </span>AGE
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>nginx<span class="w">   </span><span class="m">2</span><span class="w">               </span><span class="m">2</span><span class="w">               </span><span class="m">2</span><span class="w">                        </span>7s
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>nginx<span class="w"> </span>-o<span class="w"> </span>wide
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>NAME<span class="w">          </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">   </span>IP<span class="w">            </span>NODE<span class="w">    </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>nginx-59mbd<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>52s<span class="w">   </span><span class="m">10</span>.244.1.8<span class="w">    </span>node1<span class="w">   </span>&lt;none&gt;<span class="w">           </span><span class="m">1</span>/1
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>nginx-qvvkz<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>52s<span class="w">   </span><span class="m">10</span>.244.3.12<span class="w">   </span>node2<span class="w">   </span>&lt;none&gt;<span class="w">           </span><span class="m">1</span>/1
</code></pre></div>
<p>我们这里只有两个 Work 节点，所以一共运行了2个 Pod，每个节点上一个，和默认的 DaemonSet 行为基本一致。此外这个策略还支持用户通过配置 node 标签的 selector，来指定灰度升级某些特定类型 node 上的 Pod，比如现在我们只升级 node1 节点的应用，则可以使用 <code>selector</code> 标签来标识：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="c1"># ...</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">      </span><span class="nt">rollingUpdateType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">      </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">          </span><span class="nt">kubernetes.io/hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="c1"># ...</span>
</code></pre></div>
<p>更新应用后可以看到只会更新 node1 节点上的 Pod：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>daemon<span class="w"> </span>nginx
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>......
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>Events:
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">  </span>Type<span class="w">    </span>Reason<span class="w">            </span>Age<span class="w">    </span>From<span class="w">                  </span>Message
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span>----<span class="w">    </span>------<span class="w">            </span>----<span class="w">   </span>----<span class="w">                  </span>-------
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulCreate<span class="w">  </span>4m25s<span class="w">  </span>daemonset-controller<span class="w">  </span>Created<span class="w"> </span>pod:<span class="w"> </span>nginx-59mbd
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulCreate<span class="w">  </span>4m25s<span class="w">  </span>daemonset-controller<span class="w">  </span>Created<span class="w"> </span>pod:<span class="w"> </span>nginx-qvvkz
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulDelete<span class="w">  </span>13s<span class="w">    </span>daemonset-controller<span class="w">  </span>Deleted<span class="w"> </span>pod:<span class="w"> </span>nginx-59mbd
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">  </span>Normal<span class="w">  </span>SuccessfulCreate<span class="w">  </span>13s<span class="w">    </span>daemonset-controller<span class="w">  </span>Created<span class="w"> </span>pod:<span class="w"> </span>nginx-7jl22
</code></pre></div>
<p>和前面两个控制器一样，Advanced DaemonSet 也支持分批灰度升级，使用 Partition 进行配置，Partition 的语义是保留旧版本 Pod 的数量，默认为 0，如果在发布过程中设置了 partition，则控制器只会将 <code class="highlight"><span class="o">(</span><span class="nt">status</span><span class="p">.</span><span class="nc">DesiredNumberScheduled</span><span class="w"> </span><span class="nt">减</span><span class="w"> </span><span class="nt">partition</span><span class="o">)</span></code> 的数量 Pod 更新到最新版本。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">      </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">      </span><span class="nt">paused</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># 暂停发布</span>
</code></pre></div>
<p>同样 Advanced DaemonSet 也是支持原地升级的，只需要设置 <code>rollingUpdateType</code> 为支持原地升级的类型即可，比如这里我们将上面的应用升级方式设置为 <code>InPlaceIfPossible</code> 即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">      </span><span class="nt">rollingUpdateType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InPlaceIfPossible</span>
</code></pre></div>
<p>更新后可以通过查看控制器的事件来验证是否是通过原地升级方式更新应用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>daemon<span class="w"> </span>nginx
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>......
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>Events:
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">  </span>Type<span class="w">     </span>Reason<span class="w">                            </span>Age<span class="w">                </span>From<span class="w">                  </span>Message
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">  </span>----<span class="w">     </span>------<span class="w">                            </span>----<span class="w">               </span>----<span class="w">                  </span>-------
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">                  </span>32s<span class="w">                </span>daemonset-controller<span class="w">  </span>Created<span class="w"> </span>pod:<span class="w"> </span>nginx-m9vj9
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulCreate<span class="w">                  </span>32s<span class="w">                </span>daemonset-controller<span class="w">  </span>Created<span class="w"> </span>pod:<span class="w"> </span>nginx-tg89g
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulUpdatePodInPlace<span class="w">        </span>16s<span class="w">                </span>daemonset-controller<span class="w">  </span>successfully<span class="w"> </span>update<span class="w"> </span>pod<span class="w"> </span>nginx-tg89g<span class="w"> </span><span class="k">in</span>-place
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">  </span>Warning<span class="w">  </span>numUnavailable<span class="w"> </span>&gt;<span class="o">=</span><span class="w"> </span>maxUnavailable<span class="w">  </span>15s<span class="w"> </span><span class="o">(</span>x7<span class="w"> </span>over<span class="w"> </span>16s<span class="o">)</span><span class="w">  </span>daemonset-controller<span class="w">  </span>default/nginx<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>unavailable<span class="w"> </span>DaemonSet<span class="w"> </span>pods:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>is<span class="w"> </span>equal<span class="w"> </span>to<span class="w"> </span>or<span class="w"> </span>exceeds<span class="w"> </span>allowed<span class="w"> </span>maximum:<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">  </span>Normal<span class="w">   </span>SuccessfulUpdatePodInPlace<span class="w">        </span>14s<span class="w">                </span>daemonset-controller<span class="w">  </span>successfully<span class="w"> </span>update<span class="w"> </span>pod<span class="w"> </span>nginx-m9vj9<span class="w"> </span><span class="k">in</span>-place
</code></pre></div>
<h2 id="broadcastjob"><a href="https://openkruise.io/docs/user-manuals/broadcastjob">BroadcastJob</a><a class="headerlink" href="#broadcastjob" title="Permanent link">&para;</a></h2>
<p>这个控制器将 Pod 分发到集群中每个节点上，类似于 DaemonSet，但是 BroadcastJob 管理的 Pod 并不是长期运行的 daemon 服务，而是类似于 Job 的任务类型 Pod，在每个节点上的 Pod 都执行完成退出后，BroadcastJob 和这些 Pod 并不会占用集群资源。 这个控制器非常有利于做升级基础软件、巡检等过一段时间需要在整个集群中跑一次的工作。</p>
<p>比如我们声明一个如下所示的 BroadcastJob 对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BroadcastJob</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bcj-demo</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">  </span><span class="c1"># 一定不是一个常驻前台的进程，一定是一个任务，执行完成后需要退出的</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/bin/sh&quot;</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;-c&quot;</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;for</span><span class="nv"> </span><span class="s">i</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">9</span><span class="nv"> </span><span class="s">8</span><span class="nv"> </span><span class="s">7</span><span class="nv"> </span><span class="s">6</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">4</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">1;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">$i;</span><span class="nv"> </span><span class="s">done&quot;</span>
</code></pre></div>
<p>直接创建上面的资源对象</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>bcj<span class="w"> </span>bcj-demo
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>NAME<span class="w">       </span>DESIRED<span class="w">   </span>ACTIVE<span class="w">   </span>SUCCEEDED<span class="w">   </span>FAILED<span class="w">   </span>AGE
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>bcj-demo<span class="w">   </span><span class="m">2</span><span class="w">         </span><span class="m">0</span><span class="w">        </span><span class="m">2</span><span class="w">           </span><span class="m">0</span><span class="w">        </span>113s
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>NAME<span class="w">                     </span>READY<span class="w">   </span>STATUS<span class="w">        </span>RESTARTS<span class="w">        </span>AGE<span class="w">     </span>IP<span class="w">             </span>NODE<span class="w">    </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>bcj-demo-m4mrw<span class="w">           </span><span class="m">0</span>/1<span class="w">     </span>Completed<span class="w">     </span><span class="m">0</span><span class="w">               </span>5m16s<span class="w">   </span><span class="m">10</span>.244.1.12<span class="w">    </span>node1<span class="w">   </span>&lt;none&gt;<span class="w">           </span><span class="m">1</span>/1
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>bcj-demo-v2fdx<span class="w">           </span><span class="m">0</span>/1<span class="w">     </span>Completed<span class="w">     </span><span class="m">0</span><span class="w">               </span>5m16s<span class="w">   </span><span class="m">10</span>.244.3.37<span class="w">    </span>node2<span class="w">   </span>&lt;none&gt;<span class="w">           </span><span class="m">1</span>/1
</code></pre></div>
<p>我们可以看到创建了一个 BroadcastJob 对象后，同时启动了两个 Pod 任务，每个节点上一个，这和原生的 Job 是不太一样的。创建的 BroadcastJob 一共有以下几种状态：</p>
<ul>
<li>Desired : 期望的 Pod 数量（等同于当前集群中匹配的节点数量）</li>
<li>Active: 运行中的 Pod 数量</li>
<li>SUCCEEDED: 执行成功的 Pod 数量</li>
<li>FAILED: 执行失败的 Pod 数量</li>
</ul>
<p>此外在 BroadcastJob 对象中还可以配置任务完成后的一些策略，比如配置 completionPolicy.ttlSecondsAfterFinished: 30，表示这个 job 会在执行结束后 30s 被删除。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BroadcastJob</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">  </span><span class="nt">completionPolicy</span><span class="p">:</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">    </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">  </span><span class="c1"># ......</span>
</code></pre></div>
<p>配置 <code class="highlight"><span class="nt">completionPolicy</span><span class="p">.</span><span class="nc">activeDeadlineSeconds</span></code> 为 10，表示这个 job 会在运行超过 10s 之后被标记为失败，并把下面还在运行的 Pod 删除掉。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BroadcastJob</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">  </span><span class="nt">completionPolicy</span><span class="p">:</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">  </span><span class="c1"># ......</span>
</code></pre></div>
<p>completionPolicy 类型除了 Always 之外还可以设置为 <code>Never</code>，表示这个 job 会持续运行即使当前所有节点上的 Pod 都执行完成了。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BroadcastJob</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span><span class="nt">completionPolicy</span><span class="p">:</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">  </span><span class="c1"># ......</span>
</code></pre></div>
<h2 id="advancedcronjob"><a href="https://openkruise.io/docs/user-manuals/advancedcronjob">AdvancedCronJob</a><a class="headerlink" href="#advancedcronjob" title="Permanent link">&para;</a></h2>
<p>AdvancedCronJob 是对于原生 CronJob 的扩展版本，根据用户设置的 schedule 规则，周期性创建 Job 执行任务，而 AdvancedCronJob 的 template 支持多种不同的 job 资源：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AdvancedCronJob</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span><span class="c1"># Option 1: use jobTemplate, which is equivalent to original CronJob</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="nt">jobTemplate</span><span class="p">:</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">      </span><span class="c1"># ...</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="c1"># Option 2: use broadcastJobTemplate, which will create a BroadcastJob object when cron schedule triggers</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="nt">broadcastJobTemplate</span><span class="p">:</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">      </span><span class="c1"># ...</span>
</code></pre></div>
<ul>
<li>jobTemplate：与原生 CronJob 一样创建 Job 执行任务</li>
<li>broadcastJobTemplate：周期性创建 BroadcastJob 执行任务</li>
</ul>
<p><img alt="OpenKruiseAdvancedCronJob" src="../../assets/images/OpenKruiseAdvancedCronJob.png" title="OpenKruiseAdvancedCronJob" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AdvancedCronJob</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acj-test</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/1</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="nt">broadcastJobTemplate</span><span class="p">:</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">      </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">        </span><span class="nt">completionPolicy</span><span class="p">:</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">          </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">        </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">          </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">            </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">            </span><span class="nt">containers</span><span class="p">:</span><span class="w">  </span><span class="c1"># 一定不是一个常驻前台的进程，一定是一个任务，执行完成后需要退出的</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">              </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/bin/sh&quot;</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;-c&quot;</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;for</span><span class="nv"> </span><span class="s">i</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">9</span><span class="nv"> </span><span class="s">8</span><span class="nv"> </span><span class="s">7</span><span class="nv"> </span><span class="s">6</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">4</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">1;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">$i;</span><span class="nv"> </span><span class="s">done&quot;</span>
</code></pre></div>
<p>上述 YAML 定义了一个 AdvancedCronJob，每分钟创建一个 BroadcastJob 对象，这个 BroadcastJob 会在所有节点上运行一个 job 任务。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>acj
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>NAME<span class="w">       </span>SCHEDULE<span class="w">      </span>TYPE<span class="w">           </span>LASTSCHEDULETIME<span class="w">   </span>AGE
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>acj-test<span class="w">   </span>*/1<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w">   </span>BroadcastJob<span class="w">                      </span>8s
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>bcj
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>NAME<span class="w">                  </span>DESIRED<span class="w">   </span>ACTIVE<span class="w">   </span>SUCCEEDED<span class="w">   </span>FAILED<span class="w">   </span>AGE
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>acj-test-1646305200<span class="w">   </span><span class="m">2</span><span class="w">         </span><span class="m">0</span><span class="w">        </span><span class="m">2</span><span class="w">           </span><span class="m">0</span><span class="w">        </span>25s
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>NAME<span class="w">                        </span>READY<span class="w">   </span>STATUS<span class="w">        </span>RESTARTS<span class="w">        </span>AGE
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>acj-test-1646305200-c4jbr<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Completed<span class="w">     </span><span class="m">0</span><span class="w">               </span>41s
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>acj-test-1646305200-stsm9<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Completed<span class="w">     </span><span class="m">0</span><span class="w">               </span>41s
</code></pre></div>
<h2 id="sidecarset"><a href="https://openkruise.io/docs/user-manuals/sidecarset">SidecarSet</a><a class="headerlink" href="#sidecarset" title="Permanent link">&para;</a></h2>
<p>SidecarSet 支持通过 <code>admission webhook</code> 来自动为集群中创建的符合条件的 Pod 注入 sidecar 容器，除了在 Pod 创建时候注入外，SidecarSet 还提供了额外的功能，诸如Sidecar 容器镜像原地升级。SidecarSet 将 sidecar 容器的定义和生命周期与业务容器解耦，它主要用于管理无状态的 sidecar 容器，比如监控、日志等 agent。</p>
<p>比如我们定义一个如下所示的 SidecarSet 资源对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a># sidecarset.yaml
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>apiVersion: apps.kruise.io/v1alpha1
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>kind: SidecarSet
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>metadata:
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>  name: test-sidecarset
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>spec:
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>  selector:
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>    matchLabels:
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>      app: nginx
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>  updateStrategy:
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>    type: RollingUpdate
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>    maxUnavailable: 1
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>  containers:
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>  - name: sidecar1
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>    image: busybox
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>    command: [&quot;sleep&quot;, &quot;999d&quot;]
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>    volumeMounts:
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>    - name: log-volume
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>      mountPath: /var/log
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>  volumes: # this field will be merged into pod.spec.volumes
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>  - name: log-volume
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>    emptyDir: {}
</code></pre></div>
<p>直接创建这个资源对象即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>sidecarset
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>NAME<span class="w">              </span>MATCHED<span class="w">   </span>UPDATED<span class="w">   </span>READY<span class="w">   </span>AGE
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>test-sidecarset<span class="w">   </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">       </span>34s
</code></pre></div>
<p>需要注意上面我们在定义 SidecarSet 对象的时候里面有一个非常重要的属性就是 <code class="highlight"><span class="nt">label</span><span class="w"> </span><span class="nt">selector</span></code>，会去匹配具有 app=nginx 的 Pod，然后向其中注入下面定义的 <code>sidecar1</code> 这个容器，比如定义如下所示的一个 Pod，该 Pod 中包含 app=nginx 的标签，这样可以和上面的 SidecarSet 对象匹配：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"> </span><span class="c1"># matches the SidecarSet&#39;s selector</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
</code></pre></div>
<p>直接创建上面的资源对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>test-pod
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>NAME<span class="w">       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>test-pod<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19s
</code></pre></div>
<p>可以看到该 Pod 中有2个容器，被自动注入了上面定义的 <code>sidecar1</code> 容器：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl get pod test-pod -o yaml</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">999d</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IS_INJECTED</span>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar1</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="w">    </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/termination-log</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="w">    </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">File</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-volume</span>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/secrets/kubernetes.io/serviceaccount</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-api-access-whxz7</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-volume</span>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
</code></pre></div>
<p>现在我们去更新 SidecarSet 中的 sidecar 容器镜像替换成 <code>busybox:1.35.0</code>：</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Option 1</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>patch<span class="w"> </span>sidecarset<span class="w"> </span>test-sidecarset<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;: &quot;busybox:1.35.0&quot;}]&#39;</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>sidecarset.apps.kruise.io/test-sidecarset<span class="w"> </span>patched
</code></pre></div>
<strong>Option 2</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>edit<span class="w"> </span>sidecarsets<span class="w"> </span>test-sidecarset
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="c1"># sidecarset.yaml</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>apiVersion:<span class="w"> </span>apps.kruise.io/v1alpha1
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>kind:<span class="w"> </span>SidecarSet
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>metadata:
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">  </span>name:<span class="w"> </span>test-sidecarset
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>spec:
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">  </span>containers:
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span>-<span class="w"> </span>name:<span class="w"> </span>sidecar1
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">      </span>image:<span class="w"> </span>centos:7
</code></pre></div></p>
</div>
<p>更新后再去查看 Pod 中的 sidecar 容器：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>test-pod
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>NAME<span class="w">       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">      </span>AGE
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>test-pod<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>67s<span class="w"> </span>ago<span class="o">)</span><span class="w">   </span>28m
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>test-pod
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>......
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>Events:
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">  </span>Type<span class="w">    </span>Reason<span class="w">     </span>Age<span class="w">                </span>From<span class="w">               </span>Message
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">  </span>----<span class="w">    </span>------<span class="w">     </span>----<span class="w">               </span>----<span class="w">               </span>-------
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">  </span>......
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">  </span>Normal<span class="w">  </span>Killing<span class="w">    </span>109s<span class="w">               </span>kubelet<span class="w">            </span>Container<span class="w"> </span>sidecar1<span class="w"> </span>definition<span class="w"> </span>changed,<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>restarted
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">  </span>Normal<span class="w">  </span>Pulling<span class="w">    </span>79s<span class="w">                </span>kubelet<span class="w">            </span>Pulling<span class="w"> </span>image<span class="w"> </span><span class="s2">&quot;busybox:1.35.0&quot;</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">  </span>Normal<span class="w">  </span>Started<span class="w">    </span>62s<span class="w"> </span><span class="o">(</span>x2<span class="w"> </span>over<span class="w"> </span>28m<span class="o">)</span><span class="w">  </span>kubelet<span class="w">            </span>Started<span class="w"> </span>container<span class="w"> </span>sidecar1
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">  </span>Normal<span class="w">  </span>Created<span class="w">    </span>62s<span class="w"> </span><span class="o">(</span>x2<span class="w"> </span>over<span class="w"> </span>28m<span class="o">)</span><span class="w">  </span>kubelet<span class="w">            </span>Created<span class="w"> </span>container<span class="w"> </span>sidecar1
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">  </span>Normal<span class="w">  </span>Pulled<span class="w">     </span>62s<span class="w">                </span>kubelet<span class="w">            </span>Successfully<span class="w"> </span>pulled<span class="w"> </span>image<span class="w"> </span><span class="s2">&quot;busybox:1.35.0&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">17</span>.239369684s
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>test-pod<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>busybox
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">    </span>kruise.io/sidecarset-inplace-update-state:<span class="w"> </span><span class="s1">&#39;{&quot;test-sidecarset&quot;:{&quot;revision&quot;:&quot;f78z4854d9855xd6478fzx9c84645z2548v24z26455db46bdfzw44v49v98f2cw&quot;,&quot;updateTimestamp&quot;:&quot;2022-03-06T09:56:15Z&quot;,&quot;lastContainerStatuses&quot;:{&quot;sidecar1&quot;:{&quot;imageID&quot;:&quot;docker.io/library/busybox@sha256:5acba83a746c7608ed544dc1533b87c737a0b0fb730301639a0179f9344b1678&quot;}}}}&#39;</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">    </span>image:<span class="w"> </span>busybox:1.35.0
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">    </span>image:<span class="w"> </span>docker.io/library/busybox:1.35.0
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">    </span>imageID:<span class="w"> </span>docker.io/library/busybox@sha256:130df6999605f982ec67e5bee29d3a52614a075e949490f0a41702ee1dd98f3f
</code></pre></div>
<p>可以看到 Pod 中的 sidecar 容器镜像被原地升级成 busybox:1.35.0 了， 对主容器没有产生任何影响。</p>
<h3 id="_7">统一特性<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>需要注意的是 sidecar 的注入只会发生在 Pod 创建阶段，并且只有 Pod spec 会被更新，不会影响 Pod 所属的 workload template 模板。 spec.containers 除了默认的 k8s container 字段，还扩展了如下一些字段，来方便注入：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SidecarSet</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecarset</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sample</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">    </span><span class="c1"># 默认的K8s容器字段</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:alpine</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/nginx/conf</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">    </span><span class="c1"># 扩展的sidecar容器字段</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="hll"><span class="w">    </span><span class="nt">podInjectPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BeforeAppContainer</span>
</span><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="hll"><span class="w">    </span><span class="nt">shareVolumePolicy</span><span class="p">:</span>
</span><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="hll"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">disabled | enabled</span>
</span><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">    </span><span class="nt">transferEnv</span><span class="p">:</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sourceContainerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">      </span><span class="nt">envName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PROXY_IP</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/nginx/conf</span>
</code></pre></div>
<ul>
<li>podInjectPolicy 定义了容器 注入到 pod.spec.containers 中的位置<ul>
<li>BeforeAppContainer：表示注入到 pod 原 containers 的前面 (默认)</li>
<li>AfterAppContainer： 表示注入到 pod 原 containers 的后面</li>
</ul>
</li>
<li>shareVolumePolicy(数据卷共享)<ul>
<li>共享指定卷：通过 spec.volumes 来定义 sidecar 自身需要的 volume</li>
<li>共享所有卷：通过 spec.containers[i].shareVolumePolicy.type = enabled | disabled 来控制是否挂载 pod 应用容器的卷，常用于日志收集等 sidecar，配置为 enabled 后会把应用容器中所有挂载点注入 sidecar 同一路经下(sidecar 中本身就有声明的数据卷和挂载点除外）</li>
</ul>
</li>
<li>transferEnv(环境变量共享)：可以通过 spec.containers[i].transferEnv 来从别的容器获取环境变量，会把名为 sourceContainerName 容器中名为 envName 的环境变量拷贝到本容器</li>
</ul>
<p>SidecarSet 不仅支持 sidecar 容器的原地升级，而且提供了非常丰富的升级、灰度策略。同样在 SidecarSet 对象中 <code class="highlight"><span class="nt">updateStrategy</span></code> 属性下面也可以配置 partition 来定义保留旧版本 Pod 的数量或百分比，默认为 0；同样还可以配置的有 <code class="highlight"><span class="nt">maxUnavailable</span></code> 属性，表示在发布过程中的最大不可用数量。</p>
<ul>
<li><ins class="critic">当 {matched pod}=100,partition=50,maxUnavailable=10</ins>，控制器会发布 50 个 Pod 到新版本，但是同一时间只会发布 10 个 Pod，每发布好一个 Pod 才会再找一个发布，直到 50 个发布完成。</li>
<li><ins class="critic">当 {matched pod}=100,partition=80,maxUnavailable=30</ins>，控制器会发布 20 个 Pod 到新版本，因为满足 maxUnavailable 数量，所以这 20 个 Pod 会同时发布。</li>
</ul>
<p>同样也可以设置 <code>paused: true</code> 来暂停发布，此时对于新创建的、扩容的 pod 依旧会实现注入能力，已经更新的 pod 会保持更新后的版本不动，还没有更新的 pod 会暂停更新。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SidecarSet</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecarset</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20%</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="nt">paused</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<h3 id="_8">金丝雀发布<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>对于有金丝雀发布需求的业务，可以通过 <code>selector</code> 来实现，对于需要率先金丝雀灰度的 pod 打上固定的 <code class="highlight"><span class="o">[</span><span class="nt">canary</span><span class="p">.</span><span class="nc">release</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">true</span></code> 的标签，再通过 <code>selector.matchLabels</code> 来选中该 pod 即可。</p>
<p>比如现在我们有一个3副本的 Pod，也具有 app=nginx 的标签，如下所示</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ngx</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p>创建后现在就具有4个 app=nginx 标签的 Pod 了，由于都匹配上面创建的 SidecarSet 对象，所以都会被注入一个 sidecar1 的容器，镜像为 busybox：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>NAME<span class="w">                    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">       </span>AGE
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>nginx-6457955f7-7hnjw<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">              </span>51s
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>nginx-6457955f7-prkgz<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">              </span>51s
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>nginx-6457955f7-tbtxk<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">              </span>51s
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>test-pod<span class="w">                </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">              </span>4m2s
</code></pre></div>
<p>现在如果我们想为 test-pod 这个应用来执行灰度策略，将 sidecar 容器镜像更新成 busybox:1.35.0，则可以在 <code>updateStrategy</code> 下面添加 <code>selector.matchLabels</code> 属性 canary.release: "true"：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SidecarSet</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-sidecarset</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">        </span><span class="nt">canary.release</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar1</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.35.0</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">  </span><span class="c1"># ......</span>
</code></pre></div>
<p>然后同样需要给 test-pod 添加上 <code>canary.release=true</code> 这个标签：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="nt">canary.release</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>使用命令kubectl path或直接使用kubectl editor修改</p>
<p>直接修改资源配置文件存在bug---无法生效</p>
</div>
<p>更新后可以发现 test-pod 的 sidecar 镜像更新了，其他 Pod 没有变化，这样就实现了 sidecar 的灰度功能：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>test-pod
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>Events:
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">  </span>Type<span class="w">    </span>Reason<span class="w">     </span>Age<span class="w">                    </span>From<span class="w">               </span>Message
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">  </span>----<span class="w">    </span>------<span class="w">     </span>----<span class="w">                   </span>----<span class="w">               </span>-------
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">  </span>Normal<span class="w">  </span>Killing<span class="w">    </span>7m53s<span class="w">                  </span>kubelet<span class="w">            </span>Container<span class="w"> </span>sidecar1<span class="w"> </span>definition<span class="w"> </span>changed,<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>restarted
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">  </span>Normal<span class="w">  </span>Created<span class="w">    </span>7m23s<span class="w"> </span><span class="o">(</span>x2<span class="w"> </span>over<span class="w"> </span>8m17s<span class="o">)</span><span class="w">  </span>kubelet<span class="w">            </span>Created<span class="w"> </span>container<span class="w"> </span>sidecar1
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">  </span>Normal<span class="w">  </span>Started<span class="w">    </span>7m23s<span class="w"> </span><span class="o">(</span>x2<span class="w"> </span>over<span class="w"> </span>8m17s<span class="o">)</span><span class="w">  </span>kubelet<span class="w">            </span>Started<span class="w"> </span>container<span class="w"> </span>sidecar1
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">  </span>Normal<span class="w">  </span>Pulling<span class="w">    </span>7m23s<span class="w">                  </span>kubelet<span class="w">            </span>Pulling<span class="w"> </span>image<span class="w"> </span><span class="s2">&quot;busybox&quot;</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">  </span>Normal<span class="w">  </span>Pulled<span class="w">     </span>7m23s<span class="w">                  </span>kubelet<span class="w">            </span>Successfully<span class="w"> </span>pulled<span class="w"> </span>image<span class="w"> </span><span class="s2">&quot;busybox&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">603</span>.928658ms
</code></pre></div>
<h3 id="_9">热升级<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>SidecarSet 原地升级会先停止旧版本的容器，然后创建新版本的容器，这种方式适合不影响 Pod 服务可用性的 sidecar 容器，比如说日志收集的 Agent。</p>
<p>但是对于很多代理或运行时的 sidecar 容器，例如 Istio Envoy，这种升级方法就有问题了，Envoy 作为 Pod 中的一个代理容器，代理了所有的流量，如果直接重启，Pod 服务的可用性会受到影响，如果需要单独升级 envoy sidecar，就需要复杂的优雅终止和协调机制，所以我们为这种 sidecar 容器的升级提供了一种新的解决方案。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SidecarSet</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hotupgrade-sidecarset</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hotupgrade</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:sidecarv1</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="hll"><span class="w">    </span><span class="nt">lifecycle</span><span class="p">:</span>
</span><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="hll"><span class="w">      </span><span class="nt">postStart</span><span class="p">:</span>
</span><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">        </span><span class="nt">exec</span><span class="p">:</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="w">          </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/migrate.sh</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a><span class="w">    </span><span class="nt">upgradeStrategy</span><span class="p">:</span>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="w">      </span><span class="nt">upgradeType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HotUpgrade</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="hll"><span class="w">      </span><span class="nt">hotUpgradeEmptyImage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:empty</span>
</span></code></pre></div>
<ul>
<li><strong>upgradeType</strong>: HotUpgrade 代表该 sidecar 容器的类型是热升级方案</li>
<li><strong>hotUpgradeEmptyImage</strong>: 当热升级 sidecar 容器时，业务必须要提供一个 empty 容器用于热升级过程中的容器切换，empty 容器同 sidecar 容器具有相同的配置（除了镜像地址），例如：command、lifecycle、probe 等，但是它不做任何工作。</li>
<li><strong>lifecycle.postStart</strong>: 在 postStart 这个 hook 中完成热升级过程中的状态迁移，该脚本需要由业务根据自身的特点自行实现，例如：nginx 热升级需要完成 Listen FD 共享以及 reload 操作。</li>
</ul>
<p>整体来说热升级特性总共包含以下两个过程：</p>
<ul>
<li>Pod 创建时，注入热升级容器</li>
<li>原地升级时，完成热升级流程</li>
</ul>
<p>注入热升级容器</p>
<p>Pod 创建时，SidecarSet Webhook 将会注入两个容器：</p>
<ul>
<li><strong>{sidecarContainer.name}-1</strong>: 如下图所示 envoy-1，这个容器代表正在实际工作的 sidecar 容器，例如：envoy:1.16.0</li>
<li><strong>{sidecarContainer.name}-2</strong>: 如下图所示 envoy-2，这个容器是业务配置的 hotUpgradeEmptyImage 容器，例如：empty:1.0，用于后面的热升级机制</li>
</ul>
<p><img alt="OpenKruiseUpdateInjection" src="../../assets/images/OpenKruiseUpdateInjection.png" title="OpenKruiseUpdateInjection" /></p>
<h3 id="_10">热升级流程<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>热升级流程主要分为三个步骤：</p>
<ul>
<li><strong>Upgrade</strong>: 将 empty 容器升级为当前最新的 sidecar 容器，例如：envoy-2.Image = envoy:1.17.0</li>
<li><strong>Migration</strong>: lifecycle.postStart 完成热升级流程中的状态迁移，当迁移完成后退出</li>
<li><strong>Reset</strong>: 状态迁移完成后，热升级流程将设置 envoy-1 容器为 empty 镜像，例如：envoy-1.Image = empty:1.0</li>
</ul>
<p>上述三个步骤完成了热升级中的全部流程，当对 Pod 执行多次热升级时，将重复性的执行上述三个步骤。</p>
<p><img alt="OpenKruiseHotUpdate" src="../../assets/images/OpenKruiseHotUpdate.png" title="OpenKruiseHotUpdate" /></p>
<p>这里我们以 OpenKruise 的官方示例来进行说明，首先创建上面的 <code>hotupgrade-sidecarset</code> 这个 SidecarSet。然后创建一个如下所示的 CloneSet 对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SidecarSet</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain"># ......</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="nn">---</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CloneSet</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hotupgrade</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hotupgrade</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hotupgrade</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:busybox</span>
</code></pre></div>
<p>创建完成后，CloneSet 管理的 Pod 已经注入 sidecar-1 和 sidecar-2 两个容器:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl get sidecarset hotupgrade-sidecarset</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="l l-Scalar l-Scalar-Plain">NAME                    MATCHED   UPDATED   READY   AGE</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="l l-Scalar l-Scalar-Plain">hotupgrade-sidecarset   1         1         0       6s</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl get pods -l app=hotupgrade</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="l l-Scalar l-Scalar-Plain">NAME            READY   STATUS    RESTARTS   AGE</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="l l-Scalar l-Scalar-Plain">busybox-t7phd   3/3     Running   0          79s</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="l l-Scalar l-Scalar-Plain">kubectl get pods -l app=hotupgrade</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="l l-Scalar l-Scalar-Plain">NAME            READY   STATUS    RESTARTS   AGE</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="l l-Scalar l-Scalar-Plain">busybox-t7phd   3/3     Running   0          79s</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="l l-Scalar l-Scalar-Plain">➜ kubectl describe pods busybox-t7phd</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span><span class="w">         </span><span class="l l-Scalar l-Scalar-Plain">busybox-t7phd</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="nt">Priority</span><span class="p">:</span><span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="nt">Node</span><span class="p">:</span><span class="w">         </span><span class="l l-Scalar l-Scalar-Plain">node2/192.168.31.174</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="nt">Controlled By</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">CloneSet/busybox</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="nt">Containers</span><span class="p">:</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="w">  </span><span class="nt">sidecar-1</span><span class="p">:</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="w">    </span><span class="nt">Container ID</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">containerd://5afe9c26923508bf480238a232a2ab1457d96b51ff28024a36980544ad5c0d94</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="w">    </span><span class="nt">Image</span><span class="p">:</span><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:sidecarv1</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="w">    </span><span class="nt">Environment</span><span class="p">:</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">      </span><span class="nt">IS_INJECTED</span><span class="p">:</span><span class="w">             </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="w">      </span><span class="nt">SIDECARSET_VERSION</span><span class="p">:</span><span class="w">       </span><span class="l l-Scalar l-Scalar-Plain">(v1:metadata.annotations[&#39;version.sidecarset.kruise.io/sidecar-1&#39;])</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="w">      </span><span class="nt">SIDECARSET_VERSION_ALT</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">(v1:metadata.annotations[&#39;versionalt.sidecarset.kruise.io/sidecar-1&#39;])</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="w">  </span><span class="nt">sidecar-2</span><span class="p">:</span>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="w">    </span><span class="nt">Container ID</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">containerd://e17b576eb24985efd4154f3bc94e88bb6231b37bb391b6d611b0dc12e7a8db0b</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="w">    </span><span class="nt">Image</span><span class="p">:</span><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:empty</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="w">    </span><span class="nt">Environment</span><span class="p">:</span>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="w">      </span><span class="nt">IS_INJECTED</span><span class="p">:</span><span class="w">             </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a><span class="w">      </span><span class="nt">SIDECARSET_VERSION</span><span class="p">:</span><span class="w">       </span><span class="l l-Scalar l-Scalar-Plain">(v1:metadata.annotations[&#39;version.sidecarset.kruise.io/sidecar-2&#39;])</span>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="w">      </span><span class="nt">SIDECARSET_VERSION_ALT</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">(v1:metadata.annotations[&#39;versionalt.sidecarset.kruise.io/sidecar-2&#39;])</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="w">  </span><span class="nt">busybox</span><span class="p">:</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="w">    </span><span class="nt">Container ID</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">containerd://6d0d45a1981f63df45ce2fba958b734ccac25d010192f441d98dcc4a1b421646</span>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="w">    </span><span class="nt">Image</span><span class="p">:</span><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">openkruise/hotupgrade-sample:busybox</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
</code></pre></div>
<p>busybox 主容器每100毫秒会请求一次sidecar(version=v1)服务：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>busybox-t7phd<span class="w"> </span>-c<span class="w"> </span>busybox
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>I0306<span class="w"> </span><span class="m">11</span>:07:38.363847<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>I0306<span class="w"> </span><span class="m">11</span>:07:38.474805<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>I0306<span class="w"> </span><span class="m">11</span>:07:38.585975<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>I0306<span class="w"> </span><span class="m">11</span>:07:38.697097<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>......
</code></pre></div>
<p>现在我们去升级 sidecar 容器，将镜像修改为 <code>openkruise/hotupgrade-sample:sidecarv2</code>：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>patch<span class="w"> </span>sidecarset<span class="w"> </span>hotupgrade-sidecarset<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;: &quot;openkruise/hotupgrade-sample:sidecarv2&quot;}]&#39;</span>
</code></pre></div>
<p>更新后再去观察 pod 的状态，可以看到 sidecar-2 镜像正常更新了：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>busybox-t7phd
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>NAME<span class="w">            </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>busybox-t7phd<span class="w">   </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>6m59s
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>pods<span class="w"> </span>busybox-t7phd
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>......
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>Events:
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">  </span>......
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">  </span>Normal<span class="w">  </span>Created<span class="w">    </span>6m12s<span class="w">  </span>kubelet<span class="w">            </span>Created<span class="w"> </span>container<span class="w"> </span>busybox
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">  </span>Normal<span class="w">  </span>Started<span class="w">    </span>6m12s<span class="w">  </span>kubelet<span class="w">            </span>Started<span class="w"> </span>container<span class="w"> </span>busybox
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">  </span>Normal<span class="w">  </span>Killing<span class="w">    </span>32s<span class="w">    </span>kubelet<span class="w">            </span>Container<span class="w"> </span>sidecar-2<span class="w"> </span>definition<span class="w"> </span>changed,<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>restarted
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">  </span>Normal<span class="w">  </span>Pulling<span class="w">    </span>32s<span class="w">    </span>kubelet<span class="w">            </span>Pulling<span class="w"> </span>image<span class="w"> </span><span class="s2">&quot;openkruise/hotupgrade-sample:sidecarv2&quot;</span>
</code></pre></div>
<p>并且在更新过程中观察 busybox 容器仍然会不断请求 sidecar 服务，但是并没有失败的请求出现：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>busybox-t7phd<span class="w"> </span>-c<span class="w"> </span>busybox
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>I0306<span class="w"> </span><span class="m">11</span>:08:47.365196<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>I0306<span class="w"> </span><span class="m">11</span>:08:47.476553<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>I0306<span class="w"> </span><span class="m">11</span>:08:47.587727<span class="w">       </span><span class="m">1</span><span class="w"> </span>main.go:39<span class="o">]</span><span class="w"> </span>request<span class="w"> </span>sidecar<span class="w"> </span>server<span class="w"> </span>success,<span class="w"> </span>and<span class="w"> </span>response<span class="o">(</span><span class="nv">body</span><span class="o">=</span>This<span class="w"> </span>is<span class="w"> </span>version<span class="o">(</span>v1<span class="o">)</span><span class="w"> </span>sidecar<span class="o">)</span>
</code></pre></div>
<p>整个热升级示例代码可以参考<a href="https://github.com/openkruise/samples/tree/master/hotupgrade">GitHub</a>的实现。</p>
<h2 id="container-restart">Container Restart<a class="headerlink" href="#container-restart" title="Permanent link">&para;</a></h2>
<p><code class="highlight"><span class="nt">ContainerRecreateRequest</span></code> 控制器可以帮助用户重启/重建存量 Pod 中一个或多个容器。和 Kruise 提供的原地升级类似，当一个容器重建的时候，Pod 中的其他容器还保持正常运行，重建完成后，Pod 中除了该容器的 restartCount 增加以外不会有什么其他变化。</p>
<p>为要重建容器的 Pod 提交一个 <code class="highlight"><span class="nt">ContainerRecreateRequest</span></code> 自定义资源（缩写 CRR）：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ContainerRecreateRequest</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-namespace</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xxx</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">  </span><span class="nt">podName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-name</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">       </span><span class="c1"># 要重建的容器名字列表，至少要有 1 个</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">    </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fail</span><span class="w">                 </span><span class="c1"># &#39;Fail&#39; 或 &#39;Ignore&#39;，表示一旦有某个容器停止或重建失败， CRR 立即结束</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="w">    </span><span class="nt">orderedRecreate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">              </span><span class="c1"># &#39;true&#39; 表示要等前一个容器重建完成了，再开始重建下一个</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="w">    </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w">   </span><span class="c1"># 等待容器优雅退出的时间，不填默认用 Pod 中定义的</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="w">    </span><span class="nt">unreadyGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w">        </span><span class="c1"># 在重建之前先把 Pod 设为 not ready，并等待这段时间后再开始执行重建</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="w">    </span><span class="nt">minStartedSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">               </span><span class="c1"># 重建后新容器至少保持运行这段时间，才认为该容器重建成功</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="w">  </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w">        </span><span class="c1"># 如果 CRR 执行超过这个时间，则直接标记为结束（未结束的容器标记为失败）</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="w">  </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1800</span><span class="w">     </span><span class="c1"># CRR 结束后，过了这段时间自动被删除掉</span>
</code></pre></div>
<p>一般来说，列表中的容器会一个个被停止，但可能同时在被重建和启动，除非 <code class="highlight"><span class="l l-Scalar l-Scalar-Plain">orderedRecreate</span></code> 被设置为 <span class="rouge">true</span>。 <code class="highlight"><span class="l l-Scalar l-Scalar-Plain">unreadyGracePeriodSeconds</span></code> 功能依赖于 KruisePodReadinessGate 这个 feature-gate，后者会在每个 Pod 创建的时候注入一个 <code>readinessGate</code>，否则，默认只会给 Kruise workload 创建的 Pod 注入 <code>readinessGate</code>，也就是说只有这些 Pod 才能在 CRR 重建时使用 <code class="highlight"><span class="l l-Scalar l-Scalar-Plain">unreadyGracePeriodSeconds</span></code>。</p>
<h2 id="imagepulljob">ImagePullJob<a class="headerlink" href="#imagepulljob" title="Permanent link">&para;</a></h2>
<p>NodeImage 和 ImagePullJob 是从 Kruise v0.8.0 版本开始提供的 CRD。Kruise 会自动为每个 Node 创建一个 NodeImage，它包含了哪些镜像需要在这个 Node 上做预热，比如我们这里3个节点，则会自动创建3个 NodeImage 对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>➜<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodeimage
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>NAME<span class="w">      </span>DESIRED<span class="w">   </span>PULLING<span class="w">   </span>SUCCEED<span class="w">   </span>FAILED<span class="w">   </span>AGE
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>master1<span class="w">   </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">        </span>10d
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>node1<span class="w">     </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">        </span>10d
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>node2<span class="w">     </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">         </span><span class="m">0</span><span class="w">        </span>10d
</code></pre></div>
<p>比如我们查看 node1 节点上的 NodeImage 对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="l l-Scalar l-Scalar-Plain">➜  kruise kubectl get nodeimage node1 -o yaml</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodeImage</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="nt">beta.kubernetes.io/arch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">amd64</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">    </span><span class="nt">beta.kubernetes.io/os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">    </span><span class="nt">kubernetes.io/arch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">amd64</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="w">    </span><span class="nt">kubernetes.io/hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="w">    </span><span class="nt">kubernetes.io/os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="nt">status</span><span class="p">:</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="w">  </span><span class="nt">desired</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="w">  </span><span class="nt">failed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="w">  </span><span class="nt">pulling</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a><span class="w">  </span><span class="nt">succeeded</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<p>比如我们希望在这个节点上拉去一个 <code>ubuntu:latest</code> 镜像，则可以按照如下所示的去修改 spec：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="w">  </span><span class="nt">images</span><span class="p">:</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w">    </span><span class="nt">ubuntu</span><span class="p">:</span><span class="w">  </span><span class="c1"># 镜像 name</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">      </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span><span class="w">  </span><span class="c1"># 镜像 tag</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">        </span><span class="nt">pullPolicy</span><span class="p">:</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">          </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w">  </span><span class="c1"># [required] 拉取完成（成功或失败）超过 300s 后，将这个任务从 NodeImage 中清除</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span><span class="w">           </span><span class="c1"># [optional] 每一次拉取的超时时间, 默认为 600</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">          </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w">               </span><span class="c1"># [optional] 拉取的重试次数，默认为 3</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">          </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1200</span><span class="w">   </span><span class="c1"># [optional] 整个任务的超时时间，无默认值</span>
</code></pre></div>
<p>更新后我们可以从 status 中看到拉取进度以及结果，并且你会发现拉取完成 600s 后任务会被清除。</p>
<p>此外用户可以创建 <code>ImagePullJob</code> 对象，来指定一个镜像要在哪些节点上做预热。</p>
<p><img alt="OpenKruiseImagePull" src="../../assets/images/OpenKruiseImagePull.png" title="OpenKruiseImagePull" /></p>
<p>比如创建如下所示的 <code>ImagePullJob</code> 资源对象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps.kruise.io/v1alpha1</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImagePullJob</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">job-with-always</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.9.1</span><span class="w">   </span><span class="c1"># [required] 完整的镜像名 name:tag</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="w">  </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">      </span><span class="c1"># [optional] 最大并发拉取的节点梳理, 默认为 1</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">            </span><span class="c1"># [optional] 指定节点的 名字列表 或 标签选择器 (只能设置其中一种)</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="w">    </span><span class="nt">names</span><span class="p">:</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-1</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-2</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="w">      </span><span class="nt">node-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xxx</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="w">  </span><span class="c1"># podSelector:         # [optional] pod label 选择器来在这些 pod 所在节点上拉取镜像, 与 selector 不能同时设置.</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="w">  </span><span class="c1">#  pod-label: xxx</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">  </span><span class="nt">completionPolicy</span><span class="p">:</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w">                  </span><span class="c1"># [optional] 默认为 Always</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="w">    </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1200</span><span class="w">   </span><span class="c1"># [optional] 无默认值, 只对 Alway 类型生效</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="w">    </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w">  </span><span class="c1"># [optional] 无默认值, 只对 Alway 类型生效</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w">                     </span><span class="c1"># [optional] 默认 backoffLimit=3, timeoutSeconds=600</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="w">    </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="w">    </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="w">  </span><span class="nt">pullSecrets</span><span class="p">:</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret-name1</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret-name2</span>
</code></pre></div>
<p>我们可以在 selector 字段中指定节点的名字列表或标签选择器 (只能设置其中一种)，如果没有设置 selector 则会选择所有节点做预热。或者可以配置 <code>podSelector</code> 来在这些 pod 所在节点上拉取镜像，<ins class="critic">podSelector 与 selector 不能同时设置</ins>。</p>
<p>同时，ImagePullJob 有两种 <code class="highlight"><span class="nt">completionPolicy</span></code> 类型:</p>
<ul>
<li><strong>Always</strong>：表示这个 job 是一次性预热，不管成功、失败都会结束</li>
<li><strong>activeDeadlineSeconds</strong>：整个 job 的 deadline 结束时间</li>
<li><strong>ttlSecondsAfterFinished</strong>：结束后超过这个时间，自动清理删除 job</li>
<li><strong>Never</strong>：表示这个 job 是长期运行、不会结束，并且会每天都会在匹配的节点上重新预热一次指定的镜像</li>
</ul>
<p>同样如果你要预热的镜像<code>来自私有仓库</code>，则可以通过 <code>pullSecrets</code> 来指定仓库的 Secret 信息。</p>
<h2 id="_11">容器启动顺序<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p><code class="highlight"><span class="nt">Container</span><span class="w"> </span><span class="nt">Launch</span><span class="w"> </span><span class="nt">Priority</span></code> 提供了控制一个 Pod 中容器启动顺序的方法。通常来说 Pod 容器的启动和退出顺序是由 Kubelet 管理的，Kubernetes 曾经有一个 KEP 计划在 container 中增加一个 type 字段来标识不同类型容器的启停优先级，但是由于sig-node 考虑到对现有代码架构的改动太大，所以将该提案拒绝了。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>这个功能作用在 Pod 对象上，不管它的 owner 是什么类型的，因此可以适用于 Deployment、CloneSet 以及其他的 workload 种类。</p>
</div>
<p>比如我们可以设置按照容器顺序启动，只需要在 Pod 中定义一个 <code>apps.kruise.io/container-launch-priority</code> 的注解即可：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">    </span><span class="nt">apps.kruise.io/container-launch-priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ordered</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w">    </span><span class="c1"># ...</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">    </span><span class="c1"># ...</span>
</code></pre></div>
<p>Kruise 会保证前面的容器（sidecar）会在后面容器（main）之前启动。</p>
<p>此外我们还可以按自定义顺序启动，但是需要在 Pod 容器中添加 <code>KRUISE_CONTAINER_PRIORITY</code> 这个环境变量:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">    </span><span class="c1"># ...</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sidecar</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="w">    </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KRUISE_CONTAINER_PRIORITY</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w">    </span><span class="c1"># ...</span>
</code></pre></div>
<p>该环境变量值的范围在 [-2147483647, 2147483647]，不写默认是 0，权重高的容器，会保证在权重低的容器之前启动，但是需要注意相同权重的容器不保证启动顺序。</p>
<p>除了这些常用的增强控制器之外 OpenKruise 还有很多高级的特性，可以前往<a href="https://openkruise.io">官网</a> 了解更多信息。</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Crd/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Crd" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Crd
            </div>
          </div>
        </a>
      
      
        
        <a href="../../ConfigManage/ConfigMap/" class="md-footer__link md-footer__link--next" aria-label="下一页: ConfigMap" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              ConfigMap
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021 ~ Present Darmarj.M
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/darmarj" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  <script src="../../overrides/assets/javascripts/bundle.525231ca.min.js"></script>

  </body>
</html>